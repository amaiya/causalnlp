---

title: Examples


keywords: fastai
sidebar: home_sidebar

summary: "Various examples of **CausalNLP** on semi-simulated or real datasets."
description: "Various examples of **CausalNLP** on semi-simulated or real datasets."
nb_path: "nbs/99_examples.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/99_examples.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">reload_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">causalnlp.causalinference</span> <span class="kn">import</span> <span class="n">CausalInferenceModel</span>
<span class="kn">from</span> <span class="nn">causalnlp.autocoder</span> <span class="kn">import</span> <span class="n">Autocoder</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="What-is-the-causal-impact-of-a-positive-review-on-product-sales-(or-views)?">What is the causal impact of a positive review on product sales (or views)?<a class="anchor-link" href="#What-is-the-causal-impact-of-a-positive-review-on-product-sales-(or-views)?"> </a></h2><p>We use a semi-simulated dataset generated from <a href="https://github.com/rpryzant/causal-text">this repo</a>. The reviews and product types are real, while the outcomes (e.g., 1=clicked or bought, 0=not clicked or bought) are simulated.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;sample_data/music_seed50.tsv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">error_bad_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>index</th>
      <th>id</th>
      <th>rating</th>
      <th>product</th>
      <th>text</th>
      <th>summary</th>
      <th>price</th>
      <th>T_true</th>
      <th>C_true</th>
      <th>Y_sim</th>
      <th>negative</th>
      <th>positive</th>
      <th>T_ac</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>7</td>
      <td>0001388703</td>
      <td>1.0</td>
      <td>mp3 music</td>
      <td>buy the cd.  do not buy the mp3 album.  downlo...</td>
      <td>Buy the CD.  Do not buy the MP3.</td>
      <td>13.01</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.548733</td>
      <td>0.451267</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>8</td>
      <td>0001388703</td>
      <td>5.0</td>
      <td>mp3 music</td>
      <td>takes me back to my childhood!</td>
      <td>Love it!</td>
      <td>13.01</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0.008373</td>
      <td>0.991627</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>12</td>
      <td>0001388703</td>
      <td>5.0</td>
      <td>audio cd</td>
      <td>the passion and ingenuity of green's music is ...</td>
      <td>No one like Keith Green</td>
      <td>13.01</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0.043761</td>
      <td>0.956239</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>13</td>
      <td>0001388703</td>
      <td>5.0</td>
      <td>mp3 music</td>
      <td>keith's music is a timeless message.  since hi...</td>
      <td>Never Gets Old</td>
      <td>13.01</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0.038876</td>
      <td>0.961124</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>15</td>
      <td>0001377647</td>
      <td>5.0</td>
      <td>audio cd</td>
      <td>i have fallen in love with john michael talbot...</td>
      <td>Talbot a masterpiece</td>
      <td>18.99</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0.019828</td>
      <td>0.980172</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>C_true</code> is a confounder, where 1 is an audio CD and and 0 is something else (e.g., MP3).  In this dataset, outcomes were simulated such that <code>C_true</code> is a counfounding variable for this problem.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The treatment is whether or not the review is positive.  Let's pretend we don't have a rating and need to infer this from text using the <a href="/causalnlp/autocoder.html#Autocoder"><code>Autocoder</code></a>. This can be done with:</p>
<div class="highlight"><pre><span></span><span class="n">ac</span> <span class="o">=</span> <span class="n">Autocoder</span><span class="p">()</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">code_sentiment</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">binarize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;T_ac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;positive&#39;</span><span class="p">]</span>
</pre></div>
<p>We've already created this as the <code>T_ac</code> column (along with the <code>positive</code> and <code>negative</code> columns), so invoking the above is not needed.</p>
<p>Let's fit the causal inference model.  We will adjust for both <code>C_true</code> and the raw text of the review to minimize bias from confounding. We will use the S-Learner as the metalearner here.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cm</span> <span class="o">=</span> <span class="n">CausalInferenceModel</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> 
                    <span class="n">treatment_col</span><span class="o">=</span><span class="s1">&#39;T_ac&#39;</span><span class="p">,</span> 
                    <span class="n">outcome_col</span><span class="o">=</span><span class="s1">&#39;Y_sim&#39;</span><span class="p">,</span> 
                    <span class="n">text_col</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span>
                    <span class="n">include_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;C_true&#39;</span><span class="p">],</span>
                    <span class="n">metalearner_type</span><span class="o">=</span><span class="s1">&#39;s-learner&#39;</span><span class="p">)</span>
<span class="n">cm</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>outcome column (categorical): Y_sim
treatment column: T_ac
numerical/categorical covariates: [&#39;C_true&#39;]
text covariate: text
preprocess time:  1.097043514251709  sec
start fitting causal inference model
time to fit causal inference model:  0.07760190963745117  sec
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can calculate the overall average treatment effect (ATE) as follows:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cm</span><span class="o">.</span><span class="n">estimate_ate</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;ate&#39;: 0.12984513273333298}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since this is a simulated dataset, we can estimate the ground truth ATE: <code>0.1479</code> (14.79 pp change in outcome).</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">def</span> <span class="nf">ATE_adjusted</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
        <span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">C0_ATE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">C1_ATE</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">C0_ATE</span><span class="p">,</span> <span class="n">C1_ATE</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ATE_adjusted</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">C_true</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">T_true</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">Y_sim</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0.14785542719890196
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can also calculate the conditional average treatment effects (CATE). For instance, here is the treatment effect for those reviews that mention the word ``toddler.''</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">series</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
<span class="n">cm</span><span class="o">.</span><span class="n">estimate_ate</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;toddler&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;ate&#39;: 0.13019234181156392}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="What-is-the-causal-impact-of-a-foreclosure-or-short-sale-on-the-sale-price-of-homes-greater-than-2000-square-feet?">What is the causal impact of a foreclosure or short sale on the sale price of homes greater than 2000 square feet?<a class="anchor-link" href="#What-is-the-causal-impact-of-a-foreclosure-or-short-sale-on-the-sale-price-of-homes-greater-than-2000-square-feet?"> </a></h2><p>Despite the "NLP" in the name, <strong>CausalNLP</strong> can be used for causal analyses on traditional tabular datasets with no text fields.</p>
<p>Here, we will estimate the causal effect of an abnormal sale (e.g., short sale, foreclosure), on the sale price of homes greater than 2000 square feet.  The dataset is available on Kaggle <a href="https://www.kaggle.com/c/house-prices-advanced-regression-techniques/">here</a>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;/tmp/train.csv&#39;</span><span class="p">)</span>
<span class="n">fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;Abnorml&#39;</span> <span class="k">else</span> <span class="mi">0</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;treatment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;SaleCondition&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

<span class="c1"># estimate effect of foreclosures and short sales</span>
<span class="c1"># on sale price of homes &gt; 2000 sq.</span>
<span class="kn">from</span> <span class="nn">causalnlp.causalinference</span> <span class="kn">import</span> <span class="n">CausalInferenceModel</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">CausalInferenceModel</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
                   <span class="n">treatment_col</span><span class="o">=</span><span class="s1">&#39;treatment&#39;</span><span class="p">,</span> 
                   <span class="n">outcome_col</span><span class="o">=</span><span class="s1">&#39;SalePrice&#39;</span><span class="p">,</span>
                   <span class="n">ignore_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Id&#39;</span><span class="p">,</span> <span class="s1">&#39;SaleCondition&#39;</span><span class="p">],</span>
                    <span class="n">metalearner_type</span><span class="o">=</span><span class="s1">&#39;t-learner&#39;</span><span class="p">)</span>
<span class="n">cm</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">cm</span><span class="o">.</span><span class="n">estimate_ate</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;GrLivArea&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">2000</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>outcome column (numerical): SalePrice
treatment column: treatment
numerical/categorical covariates: [&#39;MSSubClass&#39;, &#39;MSZoning&#39;, &#39;LotFrontage&#39;, &#39;LotArea&#39;, &#39;Street&#39;, &#39;Alley&#39;, &#39;LotShape&#39;, &#39;LandContour&#39;, &#39;Utilities&#39;, &#39;LotConfig&#39;, &#39;LandSlope&#39;, &#39;Neighborhood&#39;, &#39;Condition1&#39;, &#39;Condition2&#39;, &#39;BldgType&#39;, &#39;HouseStyle&#39;, &#39;OverallQual&#39;, &#39;OverallCond&#39;, &#39;YearBuilt&#39;, &#39;YearRemodAdd&#39;, &#39;RoofStyle&#39;, &#39;RoofMatl&#39;, &#39;Exterior1st&#39;, &#39;Exterior2nd&#39;, &#39;MasVnrType&#39;, &#39;MasVnrArea&#39;, &#39;ExterQual&#39;, &#39;ExterCond&#39;, &#39;Foundation&#39;, &#39;BsmtQual&#39;, &#39;BsmtCond&#39;, &#39;BsmtExposure&#39;, &#39;BsmtFinType1&#39;, &#39;BsmtFinSF1&#39;, &#39;BsmtFinType2&#39;, &#39;BsmtFinSF2&#39;, &#39;BsmtUnfSF&#39;, &#39;TotalBsmtSF&#39;, &#39;Heating&#39;, &#39;HeatingQC&#39;, &#39;CentralAir&#39;, &#39;Electrical&#39;, &#39;1stFlrSF&#39;, &#39;2ndFlrSF&#39;, &#39;LowQualFinSF&#39;, &#39;GrLivArea&#39;, &#39;BsmtFullBath&#39;, &#39;BsmtHalfBath&#39;, &#39;FullBath&#39;, &#39;HalfBath&#39;, &#39;BedroomAbvGr&#39;, &#39;KitchenAbvGr&#39;, &#39;KitchenQual&#39;, &#39;TotRmsAbvGrd&#39;, &#39;Functional&#39;, &#39;Fireplaces&#39;, &#39;FireplaceQu&#39;, &#39;GarageType&#39;, &#39;GarageYrBlt&#39;, &#39;GarageFinish&#39;, &#39;GarageCars&#39;, &#39;GarageArea&#39;, &#39;GarageQual&#39;, &#39;GarageCond&#39;, &#39;PavedDrive&#39;, &#39;WoodDeckSF&#39;, &#39;OpenPorchSF&#39;, &#39;EnclosedPorch&#39;, &#39;3SsnPorch&#39;, &#39;ScreenPorch&#39;, &#39;PoolArea&#39;, &#39;PoolQC&#39;, &#39;Fence&#39;, &#39;MiscFeature&#39;, &#39;MiscVal&#39;, &#39;MoSold&#39;, &#39;YrSold&#39;, &#39;SaleType&#39;]
preprocess time:  0.5654458999633789  sec
start fitting causal inference model
time to fit causal inference model:  0.7499136924743652  sec
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;ate&#39;: -36015.017991264394}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

