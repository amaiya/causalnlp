---

title: Causal Inference


keywords: fastai
sidebar: home_sidebar

summary: "Causal Inference API"
description: "Causal Inference API"
nb_path: "nbs/00_causalinference.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/00_causalinference.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">reload_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="CausalInferenceModel" class="doc_header"><code>class</code> <code>CausalInferenceModel</code><a href="https://github.com/amaiya/causalnlp/tree/main/causalnlp/causalinference.py#L35" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>CausalInferenceModel</code>(<strong><code>df</code></strong>, <strong><code>metalearner_type</code></strong>=<em><code>'t-learner'</code></em>, <strong><code>treatment_col</code></strong>=<em><code>'treatment'</code></em>, <strong><code>outcome_col</code></strong>=<em><code>'outcome'</code></em>, <strong><code>text_col</code></strong>=<em><code>None</code></em>, <strong><code>ignore_cols</code></strong>=<em><code>[]</code></em>, <strong><code>include_cols</code></strong>=<em><code>[]</code></em>, <strong><code>treatment_effect_col</code></strong>=<em><code>'treatment_effect'</code></em>, <strong><code>learner</code></strong>=<em><code>None</code></em>, <strong><code>effect_learner</code></strong>=<em><code>None</code></em>, <strong><code>min_df</code></strong>=<em><code>0.05</code></em>, <strong><code>max_df</code></strong>=<em><code>0.5</code></em>, <strong><code>ngram_range</code></strong>=<em><code>(1, 1)</code></em>, <strong><code>stop_words</code></strong>=<em><code>'english'</code></em>, <strong><code>verbose</code></strong>=<em><code>1</code></em>)</p>
</blockquote>
<p>Infers causality from the data contained in <code>df</code> using a metalearner.</p>
<p>Usage:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">cm</span> <span class="o">=</span> <span class="n">CausalInferenceModel</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
                              <span class="n">treatment_col</span><span class="o">=</span><span class="s1">&#39;Is_Male?&#39;</span><span class="p">,</span>
                              <span class="n">outcome_col</span><span class="o">=</span><span class="s1">&#39;Post_Shared?&#39;</span><span class="p">,</span> <span class="n">text_col</span><span class="o">=</span><span class="s1">&#39;Post_Text&#39;</span><span class="p">,</span>
                              <span class="n">ignore_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">])</span>
    <span class="n">cm</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong>df</strong> : pandas.DataFrame containing dataset</li>
<li><p><strong>metalearner_type</strong> : metalearner model to use. One of {'t-learner', 's-learner', 'x-learner', 'r-learner'} (Default: 't-learner')</p>
</li>
<li><p><strong>treatment_col</strong> : treatment variable; column should contain binary values: 1 for treated, 0 for untreated.</p>
</li>
<li><strong>outcome_col</strong> : outcome variable; column should contain the categorical or numeric outcome values</li>
<li><strong>text_col</strong> : (optional) text column containing the strings (e.g., articles, reviews, emails).</li>
<li><strong>ignore_cols</strong> : columns to ignore in the analysis</li>
<li><strong>include_cols</strong> : columns to include as covariates (e.g., possible confounders)</li>
<li><strong>treatment_effect_col</strong> : name of column to hold causal effect estimations.  Does not need to exist.  Created by CausalNLP.</li>
<li><strong>learner</strong> : an instance of a custom learner.  If None, a default LightGBM will be used.
  # Example
   learner = LGBMClassifier(num_leaves=1000)</li>
<li><strong>effect_learner</strong>: used for x-learner/r-learner and must be regression model</li>
<li><strong>min_df</strong> : min_df parameter used for text processing using sklearn</li>
<li><strong>max_df</strong> : max_df parameter used for text procesing using sklearn</li>
<li><strong>ngram_range</strong>: ngrams used for text vectorization. default: (1,1)</li>
<li><strong>stop_words</strong> : stop words used for text processing (from sklearn)</li>
<li><strong>verbose</strong> : If 1, print informational messages.  If 0, suppress.</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="CausalInferenceModel.fit" class="doc_header"><code>CausalInferenceModel.fit</code><a href="__main__.py#L299" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>CausalInferenceModel.fit</code>()</p>
</blockquote>
<p>Fits a causal inference model and estimates outcome
with and without treatment for each observation.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="CausalInferenceModel.predict" class="doc_header"><code>CausalInferenceModel.predict</code><a href="__main__.py#L311" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>CausalInferenceModel.predict</code>(<strong><code>x</code></strong>)</p>
</blockquote>
<p>Estimates the treatment effect for each observation in <code>x</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The parameter <code>x</code> should be either a <code>pandas.DataFrame</code> or a <code>numpy.ndarray</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="CausalInferenceModel.estimate_ate" class="doc_header"><code>CausalInferenceModel.estimate_ate</code><a href="__main__.py#L320" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>CausalInferenceModel.estimate_ate</code>(<strong><code>bool_mask</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Estimates the treatment effect for each observation in
<code>self.df</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <code>bool_mask</code> parameter can be used to estimate the conditional average treatment estimate (CATE).
For instance, to estimate the average treatment effect for only those individuals over 18 years of age:</p>
<div class="highlight"><pre><span></span><span class="n">cm</span><span class="o">.</span><span class="n">estimate_ate</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">18</span><span class="p">])</span>
</pre></div>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="CausalInferenceModel.interpret" class="doc_header"><code>CausalInferenceModel.interpret</code><a href="__main__.py#L330" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>CausalInferenceModel.interpret</code>(<strong><code>normalize</code></strong>=<em><code>True</code></em>, <strong><code>plot</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Returns feature importances of treatment effect model</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Usage-Example:-Do-social-media-posts-by-women-get-shared-more-often-than-those-by-men?">Usage Example: Do social media posts by women get shared more often than those by men?<a class="anchor-link" href="#Usage-Example:-Do-social-media-posts-by-women-get-shared-more-often-than-those-by-men?"> </a></h2><p>Let's create a simulated dataset.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">itertools</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span> <span class="p">[</span><span class="mi">36</span><span class="p">,</span> <span class="mi">234</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">192</span><span class="p">]))</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Is_Male?&#39;</span><span class="p">,</span> <span class="s1">&#39;Post_Text&#39;</span><span class="p">,</span> <span class="s1">&#39;Post_Shared?&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">])</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">])]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">])</span>
<span class="n">values</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Post_Text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Post_Text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;I really love my job!&#39;</span><span class="p">,</span> <span class="s1">&#39;My boss is pretty terrible.&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">original_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">original_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Is_Male?</th>
      <th>Post_Text</th>
      <th>Post_Shared?</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>I really love my job!</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>I really love my job!</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>I really love my job!</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>I really love my job!</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>I really love my job!</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>At first glance, it seems like posts by women get shared more often.  More specifically, it appears that being male <strong>reduces</strong> your the chance your post is shared by 4.5 percentage points:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">male_probability</span> <span class="o">=</span> <span class="n">original_df</span><span class="p">[(</span><span class="n">original_df</span><span class="p">[</span><span class="s1">&#39;Is_Male?&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)][</span><span class="s1">&#39;Post_Shared?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">male_probability</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.78</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">female_probability</span> <span class="o">=</span> <span class="n">original_df</span><span class="p">[(</span><span class="n">original_df</span><span class="p">[</span><span class="s1">&#39;Is_Male?&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)][</span><span class="s1">&#39;Post_Shared?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">female_probability</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.8257142857142857</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">male_probability</span><span class="o">-</span><span class="n">female_probability</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>-0.04571428571428571</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>However, this is inaccurate. In fact, this is an example of <a href="https://en.wikipedia.org/wiki/Simpson%27s_paradox">Simpson's Paradox</a>, and the true causal effect of being male in this simulated datsaet is roughly <strong>0.05</strong> (as opposed to <strong>-0.045</strong>) with men's posts being more likely to be shared. The reason is that women in this simulation tend to make more positive posts which tend to be shared more often here. Post sentiment, then, is a <a href="https://en.wikipedia.org/wiki/Mediation_(statistics">mediator</a>, which is statistically the same thing as a <a href="https://en.wikipedia.org/wiki/Confounding">confounder</a>.</p>
<p>When controlling for the sentiment of the post (the mediator variable in this dataset), it is revealed that men's posts are, in fact, shared more often (for both negative posts and positive posts). This can be quickly and easily estimated in <strong>CausalNLP</strong>.</p>
<h3 id="Causal-Inference-from-Text-with-Autocoders">Causal Inference from Text with Autocoders<a class="anchor-link" href="#Causal-Inference-from-Text-with-Autocoders"> </a></h3><p>Let's first use the <a href="/causalnlp/autocoder.html#Autocoder"><code>Autocoder</code></a> to transform the raw text into sentiment.  We can then control for sentiment when estimating the causal effect.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">causalnlp.autocoder</span> <span class="kn">import</span> <span class="n">Autocoder</span>
<span class="n">ac</span> <span class="o">=</span> <span class="n">Autocoder</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">code_sentiment</span><span class="p">(</span><span class="n">original_df</span><span class="p">[</span><span class="s1">&#39;Post_Text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">original_df</span><span class="p">,</span> <span class="n">binarize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Is_Male?</th>
      <th>Post_Text</th>
      <th>Post_Shared?</th>
      <th>negative</th>
      <th>positive</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>I really love my job!</td>
      <td>0</td>
      <td>0.019191</td>
      <td>0.980809</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>I really love my job!</td>
      <td>0</td>
      <td>0.019191</td>
      <td>0.980809</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>I really love my job!</td>
      <td>0</td>
      <td>0.019191</td>
      <td>0.980809</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>I really love my job!</td>
      <td>0</td>
      <td>0.019191</td>
      <td>0.980809</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>I really love my job!</td>
      <td>0</td>
      <td>0.019191</td>
      <td>0.980809</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>When autocoding the raw text for sentiment, we have chosen to use the raw "probabilities" with <code>binarize=False</code>.  A binary variable can also be used with <code>binarize=True</code>.</p>
<p>Next, let's estimate the treatment effects. We will ignore the <code>positive</code> and <code>Post_Shared?</code> columns, as their information is captured by the <code>negative</code> column in this example. We will use the T-Learner. See <a href="https://arxiv.org/abs/1706.03461">this paper</a> for more information on metalearner types.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cm</span> <span class="o">=</span> <span class="n">CausalInferenceModel</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">metalearner_type</span><span class="o">=</span><span class="s1">&#39;t-learner&#39;</span><span class="p">,</span>
                          <span class="n">treatment_col</span><span class="o">=</span><span class="s1">&#39;Is_Male?&#39;</span><span class="p">,</span> <span class="n">outcome_col</span><span class="o">=</span><span class="s1">&#39;Post_Shared?&#39;</span><span class="p">,</span>
                          <span class="n">include_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;negative&#39;</span><span class="p">])</span>
<span class="n">cm</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>outcome column (categorical): Post_Shared?
treatment column: Is_Male?
numerical/categorical covariates: [&#39;negative&#39;]
preprocess time:  0.012577295303344727  sec
start fitting causal inference model
time to fit causal inference model:  0.5944626331329346  sec
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Upon controlling for sentiment, we see that the overall average treatment is correctly estimated as 0.05.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ate</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">estimate_ate</span><span class="p">()</span>
<span class="n">ate</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;ate&#39;: 0.05366850622769351}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since this is a small, simulated, toy problem, we can manually calculate the adjusted treatment effect by controlling for the single counfounder (i.e., post negativity):</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="k">def</span> <span class="nf">ATE_adjusted</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
        <span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">C0_ATE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">C1_ATE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">C0_ATE</span><span class="p">,</span> <span class="n">C1_ATE</span><span class="p">])</span>
<span class="n">ATE_adjusted</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;negative&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Is_Male?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Post_Shared?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.0534529194528211</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We see that this value is close to our estimate.</p>
<p><strong>CausalNLP</strong> allows you to easily compute conditional or individualized treatment effects.
For instance, for negative posts, being male increases the chance of your post being shared by about 4 percentage points:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cm</span><span class="o">.</span><span class="n">estimate_ate</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;negative&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.9</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;ate&#39;: 0.042535751074149745}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For positive posts, being male increases the chance of your post being shared by about 6 percentage points:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cm</span><span class="o">.</span><span class="n">estimate_ate</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;negative&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;ate&#39;: 0.06436468274776497}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">ate</span><span class="p">[</span><span class="s1">&#39;ate&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.05</span>
<span class="k">assert</span> <span class="n">ate</span><span class="p">[</span><span class="s1">&#39;ate&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.055</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Causal-Inference-Using-Raw-Text-as-a-Confounder/Mediator">Causal Inference Using Raw Text as a Confounder/Mediator<a class="anchor-link" href="#Causal-Inference-Using-Raw-Text-as-a-Confounder/Mediator"> </a></h3><p>In the example above, we approached the problem under the assumption that a specific lingustic property (sentiment) was an important mediator or confounder for which to control. In some cases, there may also be other unknown lingustic properties that are potential confounders/mediators (e.g., topic, politeness, toxic language, readability).</p>
<p>In <strong>CausalNLP</strong>, we can also use the <strong>raw text</strong> as the potential confounder/mediator.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cm</span> <span class="o">=</span> <span class="n">CausalInferenceModel</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">metalearner_type</span><span class="o">=</span><span class="s1">&#39;t-learner&#39;</span><span class="p">,</span>
                          <span class="n">treatment_col</span><span class="o">=</span><span class="s1">&#39;Is_Male?&#39;</span><span class="p">,</span> <span class="n">outcome_col</span><span class="o">=</span><span class="s1">&#39;Post_Shared?&#39;</span><span class="p">,</span> <span class="n">text_col</span><span class="o">=</span><span class="s1">&#39;Post_Text&#39;</span><span class="p">,</span>
                         <span class="n">ignore_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;negative&#39;</span><span class="p">,</span> <span class="s1">&#39;positive&#39;</span><span class="p">])</span>
<span class="n">cm</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>outcome column (categorical): Post_Shared?
treatment column: Is_Male?
numerical/categorical covariates: []
text covariate: Post_Text
preprocess time:  0.01460719108581543  sec
start fitting causal inference model
time to fit causal inference model:  0.07987689971923828  sec
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Although we have excluded the <strong>negative</strong> and <strong>positive</strong> columns as extra covariates, you can use traditional categorical/numerical covariates in combination with a text field covariate (if they exist as extra columns in the dataframe).</p>
<p>Here, we see that the same causal estimates are returned, as the text is easy to infer as positive or negative based on their correlations with the outcomes in this problem.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ate</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">estimate_ate</span><span class="p">()</span>
<span class="n">ate</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;ate&#39;: 0.05366850622769351}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cm</span><span class="o">.</span><span class="n">estimate_ate</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Post_Text&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;My boss is pretty terrible.&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;ate&#39;: 0.042535751074149745}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cm</span><span class="o">.</span><span class="n">estimate_ate</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Post_Text&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;I really love my job!&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;ate&#39;: 0.06436468274776497}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">ate</span><span class="p">[</span><span class="s1">&#39;ate&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.05</span>
<span class="k">assert</span> <span class="n">ate</span><span class="p">[</span><span class="s1">&#39;ate&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.055</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Causal-Inference-With-Text-as-a-Treatment">Causal Inference With Text as a Treatment<a class="anchor-link" href="#Causal-Inference-With-Text-as-a-Treatment"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Suppose we were interested in estimating the causal impact of <strong>sentiment</strong> on the outcome.  That is, <strong>sentiment</strong> of text is the treatment, and the <strong>gender</strong> is a potential confounder. As we did above, we can use the <a href="/causalnlp/autocoder.html#Autocoder"><code>Autocoder</code></a> to create the treatment variable.  The only difference is that we would supply the <code>binarize=True</code> as an argument.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">code_sentiment</span><span class="p">(</span><span class="n">original_df</span><span class="p">[</span><span class="s1">&#39;Post_Text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">original_df</span><span class="p">,</span> <span class="n">binarize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Is_Male?</th>
      <th>Post_Text</th>
      <th>Post_Shared?</th>
      <th>negative</th>
      <th>positive</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>I really love my job!</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>I really love my job!</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>I really love my job!</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>I really love my job!</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>I really love my job!</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cm</span> <span class="o">=</span> <span class="n">CausalInferenceModel</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">metalearner_type</span><span class="o">=</span><span class="s1">&#39;t-learner&#39;</span><span class="p">,</span>
                          <span class="n">treatment_col</span><span class="o">=</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span> <span class="n">outcome_col</span><span class="o">=</span><span class="s1">&#39;Post_Shared?&#39;</span><span class="p">,</span>
                          <span class="n">include_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Is_Male?&#39;</span><span class="p">])</span>
<span class="n">cm</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>outcome column (categorical): Post_Shared?
treatment column: positive
numerical/categorical covariates: [&#39;Is_Male?&#39;]
preprocess time:  0.008679389953613281  sec
start fitting causal inference model
time to fit causal inference model:  0.36716127395629883  sec
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ate</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">estimate_ate</span><span class="p">()</span>
<span class="n">ate</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;ate&#39;: 0.19008080596986368}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">ate</span><span class="p">[</span><span class="s1">&#39;ate&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.18</span>
<span class="k">assert</span> <span class="n">ate</span><span class="p">[</span><span class="s1">&#39;ate&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.2</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

