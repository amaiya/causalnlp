---

title: CausalNLP


keywords: fastai
sidebar: home_sidebar

summary: "CausalNLP is a practical toolkit for causal inference with text as treatment, outcome, or "controlled-for" variable."
description: "CausalNLP is a practical toolkit for causal inference with text as treatment, outcome, or "controlled-for" variable."
nb_path: "nbs/index.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Install">Install<a class="anchor-link" href="#Install"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ol>
<li><code>pip install -U pip</code></li>
<li><code>pip install causalnlp</code></li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Usage">Usage<a class="anchor-link" href="#Usage"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Example:-What-is-the-causal-impact-of-a-positive-review-on-a-product-click?">Example: What is the causal impact of a positive review on a product click?<a class="anchor-link" href="#Example:-What-is-the-causal-impact-of-a-positive-review-on-a-product-click?"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;sample_data/music_seed50.tsv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">error_bad_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The file <code>music_seed50.tsv</code> is a semi-simulated dataset from <a href="https://github.com/rpryzant/causal-text">here</a>. Columns of relevance include:</p>
<ul>
<li><code>Y_sim</code>: outcome, where 1 means product was clicked and 0 means not.</li>
<li><code>text</code>: raw text of review</li>
<li><code>rating</code>: rating associated with review (1 through 5)</li>
<li><code>T_true</code>: 1 means rating less than 3, 0 means rating of 5, where <code>T_true</code> affects the outcome <code>Y_sim</code>.</li>
<li><code>T_ac</code>: an approximation of true review sentiment (<code>T_true</code>) created with <a href="https://amaiya.github.io/causalnlp/autocoder.html">Autocoder</a> from raw review text</li>
<li><code>C_true</code>:confounding categorical variable (1=audio CD, 0=other)</li>
</ul>
<p>We'll pretend the true sentiment (i.e., review rating and <code>T_true</code>) is hidden and only use <code>T_ac</code> as the treatment variable.</p>
<p>Using the <code>text_col</code> parameter, we include the raw review text as another "controlled-for" variable.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">causalnlp.causalinference</span> <span class="kn">import</span> <span class="n">CausalInferenceModel</span>
<span class="kn">from</span> <span class="nn">lightgbm</span> <span class="kn">import</span> <span class="n">LGBMClassifier</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">CausalInferenceModel</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> 
                         <span class="n">metalearner_type</span><span class="o">=</span><span class="s1">&#39;t-learner&#39;</span><span class="p">,</span> <span class="n">learner</span><span class="o">=</span><span class="n">LGBMClassifier</span><span class="p">(</span><span class="n">num_leaves</span><span class="o">=</span><span class="mi">500</span><span class="p">),</span>
                         <span class="n">treatment_col</span><span class="o">=</span><span class="s1">&#39;T_ac&#39;</span><span class="p">,</span> <span class="n">outcome_col</span><span class="o">=</span><span class="s1">&#39;Y_sim&#39;</span><span class="p">,</span> <span class="n">text_col</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span>
                         <span class="n">include_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;C_true&#39;</span><span class="p">])</span>
<span class="n">cm</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>outcome column (categorical): Y_sim
treatment column: T_ac
numerical/categorical covariates: [&#39;C_true&#39;]
text covariate: text
preprocess time:  1.1239838600158691  sec
start fitting causal inference model
time to fit causal inference model:  10.134298324584961  sec
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Estimating-Treatment-Effects">Estimating Treatment Effects<a class="anchor-link" href="#Estimating-Treatment-Effects"> </a></h4><p>CausalNLP supports estimation of heterogeneous treatment effects (i.e., how causal impacts vary across observations, which could be documents, emails, posts, individuals, or organizations).</p>
<p>We will first calculate the overall average treatment effect (or ATE), which shows that a positive review increases the probability of a click by <strong>13 percentage points</strong> in this dataset.</p>
<p>The <strong>average treatment effect</strong> (or <strong>ATE</strong>):</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span> <span class="n">cm</span><span class="o">.</span><span class="n">estimate_ate</span><span class="p">()</span> <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{&#39;ate&#39;: 0.1309311542209525}
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <strong>conditional average treatment effect</strong> (or <strong>CATE</strong>) for those reviews that mention the word "toddler" is:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span> <span class="n">cm</span><span class="o">.</span><span class="n">estimate_ate</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;toddler&#39;</span><span class="p">))</span> <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{&#39;ate&#39;: 0.15559234254638685}
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can also estimate <strong>individualized treatment effects</strong> (or <strong>ITE</strong>) for new observations using <code>CausalInfernceModel.predict</code>.  Make sure the supplied DataFrame contains the right columns.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cm</span><span class="o">.</span><span class="n">get_required_columns</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;T_ac&#39;, &#39;C_true&#39;, &#39;text&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;T_ac&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;C_true&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;text&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;I never bought this album, but I love his music and will soon!&#39;</span><span class="p">]</span>
      <span class="p">})</span>
<span class="n">effect</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">effect</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[[0.80538201]]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Features most predictive of the treatment effects (i.e., probability of clicking product):</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span> <span class="n">cm</span><span class="o">.</span><span class="n">interpret</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">10</span><span class="p">]</span> <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>v_music    0.079042
v_cd       0.066838
v_album    0.055168
v_like     0.040784
v_love     0.040635
C_true     0.039949
v_just     0.035671
v_song     0.035362
v_great    0.029918
v_heard    0.028373
dtype: float64
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Features with the <code>v_</code> prefix are word features. <code>C_true</code> is the categorical variable indicating whether or not the product is a CD.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Documentation">Documentation<a class="anchor-link" href="#Documentation"> </a></h2><p>API documentation and additional usage examples are available at: <a href="https://amaiya.github.io/causalnlp/">https://amaiya.github.io/causalnlp/</a></p>
<h2 id="How-to-Cite">How to Cite<a class="anchor-link" href="#How-to-Cite"> </a></h2><p>Please cite <a href="https://arxiv.org/abs/2106.08043">the following paper</a> when using CausalNLP in your work:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code>@article{maiya2021causalnlp,
    title={CausalNLP: A Practical Toolkit for Causal Inference with Text},
    author={Arun S. Maiya},
    year={2021},
    eprint={2106.08043},
    archivePrefix={arXiv},
    primaryClass={cs.CL},
    journal={arXiv preprint arXiv:2106.08043},
}</code></pre>

</div>
</div>
</div>
</div>
 

