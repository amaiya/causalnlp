---

title: Metalearner Utils


keywords: fastai
sidebar: home_sidebar

summary: "Metalearner Utils"
description: "Metalearner Utils"
nb_path: "nbs/05f_meta.utils.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/05f_meta.utils.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="convert_pd_to_np" class="doc_header"><code>convert_pd_to_np</code><a href="https://github.com/amaiya/causalnlp/tree/main/causalnlp/meta/utils.py#L33" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>convert_pd_to_np</code>(<strong>*<code>args</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="check_treatment_vector" class="doc_header"><code>check_treatment_vector</code><a href="https://github.com/amaiya/causalnlp/tree/main/causalnlp/meta/utils.py#L38" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>check_treatment_vector</code>(<strong><code>treatment</code></strong>, <strong><code>control_name</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="check_p_conditions" class="doc_header"><code>check_p_conditions</code><a href="https://github.com/amaiya/causalnlp/tree/main/causalnlp/meta/utils.py#L47" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>check_p_conditions</code>(<strong><code>p</code></strong>, <strong><code>t_groups</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="check_explain_conditions" class="doc_header"><code>check_explain_conditions</code><a href="https://github.com/amaiya/causalnlp/tree/main/causalnlp/meta/utils.py#L63" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>check_explain_conditions</code>(<strong><code>method</code></strong>, <strong><code>models</code></strong>, <strong><code>X</code></strong>=<em><code>None</code></em>, <strong><code>treatment</code></strong>=<em><code>None</code></em>, <strong><code>y</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="clean_xgboost_objective" class="doc_header"><code>clean_xgboost_objective</code><a href="https://github.com/amaiya/causalnlp/tree/main/causalnlp/meta/utils.py#L76" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>clean_xgboost_objective</code>(<strong><code>objective</code></strong>)</p>
</blockquote>
<p>Translate objective to be compatible with loaded xgboost version</p>
<h2 id="Args">Args<a class="anchor-link" href="#Args"> </a></h2><p>objective : string
    The objective to translate.</p>
<h2 id="Returns">Returns<a class="anchor-link" href="#Returns"> </a></h2><p>The translated objective, or original if no translation was required.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_xgboost_objective_metric" class="doc_header"><code>get_xgboost_objective_metric</code><a href="https://github.com/amaiya/causalnlp/tree/main/causalnlp/meta/utils.py#L101" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_xgboost_objective_metric</code>(<strong><code>objective</code></strong>)</p>
</blockquote>
<p>Get the xgboost version-compatible objective and evaluation metric from a potentially version-incompatible input.</p>
<h2 id="Args">Args<a class="anchor-link" href="#Args"> </a></h2><p>objective : string
    An xgboost objective that may be incompatible with the installed version.</p>
<h2 id="Returns">Returns<a class="anchor-link" href="#Returns"> </a></h2><p>A tuple with the translated objective and evaluation metric.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ape" class="doc_header"><code>ape</code><a href="https://github.com/amaiya/causalnlp/tree/main/causalnlp/meta/utils.py#L144" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>ape</code>(<strong><code>y</code></strong>, <strong><code>p</code></strong>)</p>
</blockquote>
<p>Absolute Percentage Error (APE).
Args:
    y (float): target
    p (float): prediction</p>
<p>Returns:
    e (float): APE</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="mape" class="doc_header"><code>mape</code><a href="https://github.com/amaiya/causalnlp/tree/main/causalnlp/meta/utils.py#L158" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>mape</code>(<strong><code>y</code></strong>, <strong><code>p</code></strong>)</p>
</blockquote>
<p>Mean Absolute Percentage Error (MAPE).
Args:
    y (numpy.array): target
    p (numpy.array): prediction</p>
<p>Returns:
    e (numpy.float64): MAPE</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="smape" class="doc_header"><code>smape</code><a href="https://github.com/amaiya/causalnlp/tree/main/causalnlp/meta/utils.py#L172" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>smape</code>(<strong><code>y</code></strong>, <strong><code>p</code></strong>)</p>
</blockquote>
<p>Symmetric Mean Absolute Percentage Error (sMAPE).
Args:
    y (numpy.array): target
    p (numpy.array): prediction</p>
<p>Returns:
    e (numpy.float64): sMAPE</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="rmse" class="doc_header"><code>rmse</code><a href="https://github.com/amaiya/causalnlp/tree/main/causalnlp/meta/utils.py#L184" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>rmse</code>(<strong><code>y</code></strong>, <strong><code>p</code></strong>)</p>
</blockquote>
<p>Root Mean Squared Error (RMSE).
Args:
    y (numpy.array): target
    p (numpy.array): prediction</p>
<p>Returns:
    e (numpy.float64): RMSE</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="gini" class="doc_header"><code>gini</code><a href="https://github.com/amaiya/causalnlp/tree/main/causalnlp/meta/utils.py#L200" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>gini</code>(<strong><code>y</code></strong>, <strong><code>p</code></strong>)</p>
</blockquote>
<p>Normalized Gini Coefficient.</p>
<p>Args:
    y (numpy.array): target
    p (numpy.array): prediction</p>
<p>Returns:
    e (numpy.float64): normalized Gini coefficient</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="regression_metrics" class="doc_header"><code>regression_metrics</code><a href="https://github.com/amaiya/causalnlp/tree/main/causalnlp/meta/utils.py#L235" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>regression_metrics</code>(<strong><code>y</code></strong>, <strong><code>p</code></strong>, <strong><code>w</code></strong>=<em><code>None</code></em>, <strong><code>metrics</code></strong>=<em><code>{'RMSE': &lt;function rmse at 0x7f2b5b564a60&gt;, 'sMAPE': &lt;function smape at 0x7f2b5b5649d0&gt;, 'Gini': &lt;function gini at 0x7f2b5b564af0&gt;}</code></em>)</p>
</blockquote>
<p>Log metrics for regressors.</p>
<p>Args:
    y (numpy.array): target
    p (numpy.array): prediction
    w (numpy.array, optional): a treatment vector (1 or True: treatment, 0 or False: control). If given, log
        metrics for the treatment and control group separately
    metrics (dict, optional): a dictionary of the metric names and functions</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="logloss" class="doc_header"><code>logloss</code><a href="https://github.com/amaiya/causalnlp/tree/main/causalnlp/meta/utils.py#L265" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>logloss</code>(<strong><code>y</code></strong>, <strong><code>p</code></strong>)</p>
</blockquote>
<p>Bounded log loss error.
Args:
    y (numpy.array): target
    p (numpy.array): prediction
Returns:
    bounded log loss error</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="classification_metrics" class="doc_header"><code>classification_metrics</code><a href="https://github.com/amaiya/causalnlp/tree/main/causalnlp/meta/utils.py#L279" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>classification_metrics</code>(<strong><code>y</code></strong>, <strong><code>p</code></strong>, <strong><code>w</code></strong>=<em><code>None</code></em>, <strong><code>metrics</code></strong>=<em><code>{'AUC': &lt;function roc_auc_score at 0x7f2b6c9455e0&gt;, 'Log Loss': &lt;function logloss at 0x7f2b5b564c10&gt;}</code></em>)</p>
</blockquote>
<p>Log metrics for classifiers.</p>
<p>Args:
    y (numpy.array): target
    p (numpy.array): prediction
    w (numpy.array, optional): a treatment vector (1 or True: treatment, 0 or False: control). If given, log
        metrics for the treatment and control group separately
    metrics (dict, optional): a dictionary of the metric names and functions</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="smd" class="doc_header"><code>smd</code><a href="https://github.com/amaiya/causalnlp/tree/main/causalnlp/meta/utils.py#L307" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>smd</code>(<strong><code>feature</code></strong>, <strong><code>treatment</code></strong>)</p>
</blockquote>
<p>Calculate the standard mean difference (SMD) of a feature between the
treatment and control groups.</p>
<p>The definition is available at
<a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3144483/#s11title">https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3144483/#s11title</a></p>
<p>Args:
    feature (pandas.Series): a column of a feature to calculate SMD for
    treatment (pandas.Series): a column that indicate whether a row is in
                               the treatment group or not</p>
<p>Returns:
    (float): The SMD of the feature</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="create_table_one" class="doc_header"><code>create_table_one</code><a href="https://github.com/amaiya/causalnlp/tree/main/causalnlp/meta/utils.py#L327" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>create_table_one</code>(<strong><code>data</code></strong>, <strong><code>treatment_col</code></strong>, <strong><code>features</code></strong>)</p>
</blockquote>
<p>Report balance in input features between the treatment and control groups.</p>
<p>References:
    R's tableone at CRAN: <a href="https://github.com/kaz-yos/tableone">https://github.com/kaz-yos/tableone</a>
    Python's tableone at PyPi: <a href="https://github.com/tompollard/tableone">https://github.com/tompollard/tableone</a></p>
<p>Args:
    data (pandas.DataFrame): total or matched sample data
    treatment_col (str): the column name for the treatment
    features (list of str): the column names of features</p>
<p>Returns:
    (pandas.DataFrame): A table with the means and standard deviations in
        the treatment and control groups, and the SMD between two groups
        for the features.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="NearestNeighborMatch" class="doc_header"><code>class</code> <code>NearestNeighborMatch</code><a href="https://github.com/amaiya/causalnlp/tree/main/causalnlp/meta/utils.py#L368" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>NearestNeighborMatch</code>(<strong><code>caliper</code></strong>=<em><code>0.2</code></em>, <strong><code>replace</code></strong>=<em><code>False</code></em>, <strong><code>ratio</code></strong>=<em><code>1</code></em>, <strong><code>shuffle</code></strong>=<em><code>True</code></em>, <strong><code>random_state</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Propensity score matching based on the nearest neighbor algorithm.</p>
<p>Attributes:
    caliper (float): threshold to be considered as a match.
    replace (bool): whether to match with replacement or not
    ratio (int): ratio of control / treatment to be matched. used only if
        replace=True.
    shuffle (bool): whether to shuffle the treatment group data before
        matching
    random_state (numpy.random.RandomState or int): RandomState or an int
        seed</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="MatchOptimizer" class="doc_header"><code>class</code> <code>MatchOptimizer</code><a href="https://github.com/amaiya/causalnlp/tree/main/causalnlp/meta/utils.py#L501" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>MatchOptimizer</code>(<strong><code>treatment_col</code></strong>=<em><code>'is_treatment'</code></em>, <strong><code>ps_col</code></strong>=<em><code>'pihat'</code></em>, <strong><code>user_col</code></strong>=<em><code>None</code></em>, <strong><code>matching_covariates</code></strong>=<em><code>['pihat']</code></em>, <strong><code>max_smd</code></strong>=<em><code>0.1</code></em>, <strong><code>max_deviation</code></strong>=<em><code>0.1</code></em>, <strong><code>caliper_range</code></strong>=<em><code>(0.01, 0.5)</code></em>, <strong><code>max_pihat_range</code></strong>=<em><code>(0.95, 0.999)</code></em>, <strong><code>max_iter_per_param</code></strong>=<em><code>5</code></em>, <strong><code>min_users_per_group</code></strong>=<em><code>1000</code></em>, <strong><code>smd_cols</code></strong>=<em><code>['pihat']</code></em>, <strong><code>dev_cols_transformations</code></strong>=<em><code>{'pihat': &lt;function mean at 0x7f2ba076db80&gt;}</code></em>, <strong><code>dev_factor</code></strong>=<em><code>1.0</code></em>, <strong><code>verbose</code></strong>=<em><code>True</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

</div>


